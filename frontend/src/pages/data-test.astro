---
import Layout from '../layouts/Layout.astro';
---

<style>
	/* D3 chart axes inherit text color from Tailwind theme (dark mode aware) */
	.chart-container text {
		fill: currentColor;
	}
	.chart-container .domain,
	.chart-container .tick line {
		stroke: currentColor;
	}
</style>

<Layout>
	<div class="p-6 max-w-4xl mx-auto space-y-12">
		<h1 class="text-2xl font-bold text-slate-900 dark:text-slate-100">Data Test – Oslo Bysykkel</h1>
		<p class="text-slate-600 dark:text-slate-400">
			EDA charts from prepared-data (D3 + static figures)
		</p>

		<section id="dataset-info-section">
			<h2 class="text-lg font-semibold mb-2 text-slate-800 dark:text-slate-200">Dataset Info & Summary</h2>
			<div id="dataset-info" class="space-y-4"></div>
			<p id="status-dataset-info" class="mt-2 text-sm text-slate-500 dark:text-slate-400">Loading…</p>
		</section>

		<section id="statistical-moments-section">
			<h2 class="text-lg font-semibold mb-2 text-slate-800 dark:text-slate-200">Statistical Moments (Trip Duration)</h2>
			<div id="statistical-moments" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3"></div>
			<p id="status-moments" class="mt-2 text-sm text-slate-500 dark:text-slate-400">Loading…</p>
		</section>

		<section>
			<h2 class="text-lg font-semibold mb-2 text-slate-800 dark:text-slate-200">Temporal Patterns</h2>
			<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
				<div>
					<h3 class="text-sm font-medium mb-1 text-slate-700 dark:text-slate-300">Average Trip Duration by Month</h3>
					<div id="chart-time-series" class="chart-container w-full min-h-[280px] text-slate-700 dark:text-slate-300"></div>
				</div>
				<div>
					<h3 class="text-sm font-medium mb-1 text-slate-700 dark:text-slate-300">Trip Count by Month</h3>
					<div id="chart-trip-count" class="chart-container w-full min-h-[280px] text-slate-700 dark:text-slate-300"></div>
				</div>
			</div>
			<p id="status-time-series" class="mt-2 text-sm text-slate-500 dark:text-slate-400">Loading…</p>
		</section>

		<section>
			<h2 class="text-lg font-semibold mb-2 text-slate-800 dark:text-slate-200">Duration Distribution (0–60 min)</h2>
			<div id="chart-duration" class="chart-container w-full min-h-[300px] text-slate-700 dark:text-slate-300"></div>
			<p id="status-duration" class="mt-2 text-sm text-slate-500 dark:text-slate-400">Loading…</p>
		</section>

		<section>
			<h2 class="text-lg font-semibold mb-2 text-slate-800 dark:text-slate-200">Top 10 Stations by Trip Count</h2>
			<div id="chart-stations" class="chart-container w-full min-h-[300px] text-slate-700 dark:text-slate-300"></div>
			<p id="status-stations" class="mt-2 text-sm text-slate-500 dark:text-slate-400">Loading…</p>
		</section>

		<section>
			<h2 class="text-lg font-semibold mb-2 text-slate-800 dark:text-slate-200">Missing Values per Column</h2>
			<div id="chart-nulls" class="chart-container w-full min-h-[200px] text-slate-700 dark:text-slate-300"></div>
			<p id="status-nulls" class="mt-2 text-sm text-slate-500 dark:text-slate-400">Loading…</p>
		</section>

		<section>
			<h2 class="text-lg font-semibold mb-2 text-slate-800 dark:text-slate-200">Outlier Detection (Duration)</h2>
			<p class="text-sm text-slate-500 dark:text-slate-400 mb-2">Exported as image (raw data too large)</p>
			<div id="outlier-figure" class="w-full"></div>
		</section>
	</div>
</Layout>

<script>
	import * as d3 from 'd3';
	import { loadPreparedData } from '../data/load-prepared-data';
	import type { EdaSummaryStats, DatasetInfo, SummaryStats } from '../data/prepared-data-types';

	const base = import.meta.env.BASE_URL ?? '/';

	const margin = { top: 20, right: 30, bottom: 50, left: 50 };
	const chartHeight = 280;

	async function render() {
		try {
			const { data } = await loadPreparedData<EdaSummaryStats>('eda_summary_stats.json');
			if (!data) {
				updateStatus('No data. Run the pipeline and npm run prepare:data.');
				return;
			}

			// Dataset info & summary
			renderDatasetInfo(data.dataset_info, data.summary_stats);

			// Statistical moments (duration)
			renderStatisticalMoments(data.duration_stats);

			// Temporal patterns: avg duration + trip count by month
			renderTimeSeries(data.avg_by_month ?? []);
			renderTripCountChart(data.avg_by_month ?? []);

			// Duration histogram: duration_distribution (1-min bins 0–60)
			renderDurationHistogram(data.duration_distribution ?? []);

			// Top 10 stations (hardcoded)
			const topN = 10;
			renderStations((data.station_trip_counts ?? []).slice(0, topN));

			// Missing values: null_counts_per_column
			renderNullCounts(data.null_counts_per_column ?? {});

			// Outlier figure (static image)
			renderOutlierFigure();
		} catch (err) {
			updateStatus(`Error: ${err instanceof Error ? err.message : String(err)}`);
		}
	}

	function updateStatus(msg: string) {
		for (const id of ['status-time-series', 'status-duration', 'status-stations', 'status-nulls', 'status-dataset-info', 'status-moments']) {
			const el = document.getElementById(id);
			if (el) el.textContent = msg;
		}
	}

	function renderDatasetInfo(datasetInfo?: DatasetInfo, summaryStats?: SummaryStats) {
		const container = document.getElementById('dataset-info');
		const status = document.getElementById('status-dataset-info');
		if (!container || !status) return;
		container.innerHTML = '';
		if (!datasetInfo && !summaryStats) {
			status.textContent = 'Dataset info not available. Run the pipeline to export.';
			return;
		}
		status.textContent = '';

		if (datasetInfo) {
			const infoDiv = document.createElement('div');
			infoDiv.className = 'grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4';
			infoDiv.innerHTML = `
				<div class="rounded-lg border border-slate-200 dark:border-slate-600 p-3 bg-slate-50 dark:bg-slate-800">
					<div class="text-xs text-slate-500 dark:text-slate-400">Rows</div>
					<div class="text-lg font-semibold text-slate-900 dark:text-slate-100">${datasetInfo.n_rows.toLocaleString()}</div>
				</div>
				<div class="rounded-lg border border-slate-200 dark:border-slate-600 p-3 bg-slate-50 dark:bg-slate-800">
					<div class="text-xs text-slate-500 dark:text-slate-400">Columns</div>
					<div class="text-lg font-semibold text-slate-900 dark:text-slate-100">${datasetInfo.n_columns}</div>
				</div>
				<div class="rounded-lg border border-slate-200 dark:border-slate-600 p-3 bg-slate-50 dark:bg-slate-800">
					<div class="text-xs text-slate-500 dark:text-slate-400">Memory</div>
					<div class="text-lg font-semibold text-slate-900 dark:text-slate-100">${datasetInfo.memory_mb.toFixed(2)} MB</div>
				</div>
			`;
			container.appendChild(infoDiv);

			const colsTable = document.createElement('div');
			colsTable.className = 'overflow-x-auto';
			colsTable.innerHTML = `
				<table class="min-w-full text-sm border border-slate-200 dark:border-slate-600 rounded-lg overflow-hidden text-slate-900 dark:text-slate-100 bg-white dark:bg-slate-800">
					<thead class="bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-slate-100">
						<tr><th class="text-left p-2">Column</th><th class="text-left p-2">Type</th><th class="text-right p-2">Non-null</th></tr>
					</thead>
					<tbody class="divide-y divide-slate-200 dark:divide-slate-600">
						${datasetInfo.columns.map((c) => `<tr><td class="p-2 font-mono text-slate-900 dark:text-slate-100">${c.name}</td><td class="p-2 text-slate-600 dark:text-slate-400">${c.dtype}</td><td class="p-2 text-right text-slate-900 dark:text-slate-100">${c.non_null.toLocaleString()}</td></tr>`).join('')}
					</tbody>
				</table>
			`;
			container.appendChild(colsTable);
		}

		if (summaryStats && Object.keys(summaryStats).length > 0) {
			const summaryDiv = document.createElement('div');
			summaryDiv.className = 'mt-4';
			summaryDiv.innerHTML = '<h3 class="text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">Summary Stats (numeric columns)</h3>';
			const statsTable = document.createElement('div');
			statsTable.className = 'overflow-x-auto';
			const cols = Object.keys(summaryStats);
			const stats = cols.length ? Object.keys(summaryStats[cols[0]]) : [];
			statsTable.innerHTML = `
				<table class="min-w-full text-sm border border-slate-200 dark:border-slate-600 rounded-lg overflow-hidden text-slate-900 dark:text-slate-100 bg-white dark:bg-slate-800">
					<thead class="bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-slate-100">
						<tr><th class="text-left p-2">Column</th>${stats.map((s) => `<th class="text-right p-2">${s}</th>`).join('')}</tr>
					</thead>
					<tbody class="divide-y divide-slate-200 dark:divide-slate-600">
						${cols.map((col) => `<tr><td class="p-2 font-mono text-slate-900 dark:text-slate-100">${col}</td>${stats.map((s) => `<td class="p-2 text-right text-slate-900 dark:text-slate-100">${typeof summaryStats[col][s] === 'number' ? (summaryStats[col][s] as number).toLocaleString(undefined, { maximumFractionDigits: 2 }) : summaryStats[col][s]}</td>`).join('')}</tr>`).join('')}
					</tbody>
				</table>
			`;
			summaryDiv.appendChild(statsTable);
			container.appendChild(summaryDiv);
		}
	}

	function renderStatisticalMoments(durationStats?: { mean_min: number; median_min: number; std_min: number; skewness: number; kurtosis: number }) {
		const container = document.getElementById('statistical-moments');
		const status = document.getElementById('status-moments');
		if (!container || !status) return;
		container.innerHTML = '';
		if (!durationStats) {
			status.textContent = 'Duration stats not available.';
			return;
		}
		status.textContent = '';
		const items = [
			{ label: 'Mean (min)', value: durationStats.mean_min.toFixed(2) },
			{ label: 'Median (min)', value: durationStats.median_min.toFixed(2) },
			{ label: 'Std (min)', value: durationStats.std_min.toFixed(2) },
			{ label: 'Skewness', value: durationStats.skewness.toFixed(2) },
			{ label: 'Kurtosis', value: durationStats.kurtosis.toFixed(2) },
		];
		items.forEach(({ label, value }) => {
			const card = document.createElement('div');
			card.className = 'rounded-lg border border-slate-200 dark:border-slate-600 p-3 bg-slate-50 dark:bg-slate-800';
			card.innerHTML = `<div class="text-xs text-slate-500 dark:text-slate-400">${label}</div><div class="text-lg font-semibold text-slate-900 dark:text-slate-100 font-mono">${value}</div>`;
			container.appendChild(card);
		});
	}

	function getContainer(id: string): HTMLDivElement {
		const el = document.getElementById(id);
		if (!el) throw new Error(`Container ${id} not found`);
		return el as HTMLDivElement;
	}

	function renderTimeSeries(rows: Array<{ year: number; month: number; avg_duration_min: number; trip_count: number }>) {
		const container = getContainer('chart-time-series');
		const status = getContainer('status-time-series');
		container.innerHTML = '';
		if (!rows.length) {
			status.textContent = 'No time series data.';
			return;
		}
		status.textContent = `${rows.length} months loaded.`;

		const width = container.clientWidth - margin.left - margin.right;
		const height = chartHeight - margin.top - margin.bottom;

		const svg = d3
			.select(container)
			.append('svg')
			.attr('width', width + margin.left + margin.right)
			.attr('height', height + margin.top + margin.bottom)
			.append('g')
			.attr('transform', `translate(${margin.left},${margin.top})`);

		const labels = rows.map((d) => `${d.year}-${String(d.month).padStart(2, '0')}`);
		const x = d3.scaleBand().domain(labels).range([0, width]).padding(0.1);
		const y = d3
			.scaleLinear()
			.domain([0, d3.max(rows, (d) => d.avg_duration_min) ?? 20])
			.nice()
			.range([height, 0]);

		svg.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(x))
			.selectAll('text')
			.attr('transform', 'rotate(-45)')
			.style('text-anchor', 'end');

		svg.append('g').call(d3.axisLeft(y));

		svg
			.selectAll('rect')
			.data(rows)
			.join('rect')
			.attr('x', (d) => x(`${d.year}-${String(d.month).padStart(2, '0')}`) ?? 0)
			.attr('y', (d) => y(d.avg_duration_min))
			.attr('width', x.bandwidth())
			.attr('height', (d) => height - y(d.avg_duration_min))
			.attr('fill', 'steelblue')
			.attr('opacity', 0.8);
	}

	function renderTripCountChart(rows: Array<{ year: number; month: number; avg_duration_min: number; trip_count: number }>) {
		const container = getContainer('chart-trip-count');
		container.innerHTML = '';
		if (!rows.length) return;

		const width = container.clientWidth - margin.left - margin.right;
		const height = chartHeight - margin.top - margin.bottom;

		const svg = d3
			.select(container)
			.append('svg')
			.attr('width', width + margin.left + margin.right)
			.attr('height', height + margin.top + margin.bottom)
			.append('g')
			.attr('transform', `translate(${margin.left},${margin.top})`);

		const labels = rows.map((d) => `${d.year}-${String(d.month).padStart(2, '0')}`);
		const x = d3.scaleBand().domain(labels).range([0, width]).padding(0.1);
		const y = d3
			.scaleLinear()
			.domain([0, d3.max(rows, (d) => d.trip_count) ?? 1])
			.nice()
			.range([height, 0]);

		svg.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(x))
			.selectAll('text')
			.attr('transform', 'rotate(-45)')
			.style('text-anchor', 'end');

		svg.append('g').call(d3.axisLeft(y));

		svg
			.selectAll('rect')
			.data(rows)
			.join('rect')
			.attr('x', (d) => x(`${d.year}-${String(d.month).padStart(2, '0')}`) ?? 0)
			.attr('y', (d) => y(d.trip_count))
			.attr('width', x.bandwidth())
			.attr('height', (d) => height - y(d.trip_count))
			.attr('fill', '#7b1fa2')
			.attr('opacity', 0.8);
	}

	function renderDurationHistogram(bins: Array<{ bin_min: number; count: number }>) {
		const container = getContainer('chart-duration');
		const status = getContainer('status-duration');
		container.innerHTML = '';
		if (!bins.length) {
			status.textContent = 'No duration distribution data.';
			return;
		}
		status.textContent = `${bins.length} bins (0–60 min).`;

		const width = container.clientWidth - margin.left - margin.right;
		const height = chartHeight - margin.top - margin.bottom;

		const svg = d3
			.select(container)
			.append('svg')
			.attr('width', width + margin.left + margin.right)
			.attr('height', height + margin.top + margin.bottom)
			.append('g')
			.attr('transform', `translate(${margin.left},${margin.top})`);

		const x = d3.scaleBand()
			.domain(bins.map((d) => String(d.bin_min)))
			.range([0, width])
			.padding(0.1);
		const y = d3
			.scaleLinear()
			.domain([0, d3.max(bins, (d) => d.count) ?? 1])
			.nice()
			.range([height, 0]);

		svg.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(x));
		svg.append('g').call(d3.axisLeft(y));

		svg
			.selectAll('rect')
			.data(bins)
			.join('rect')
			.attr('x', (d) => x(String(d.bin_min)) ?? 0)
			.attr('y', (d) => y(d.count))
			.attr('width', x.bandwidth())
			.attr('height', (d) => height - y(d.count))
			.attr('fill', '#2e7d32')
			.attr('opacity', 0.8);
	}

	function renderStations(stations: Array<{ station_name: string; trip_count: number }>) {
		const container = getContainer('chart-stations');
		const status = getContainer('status-stations');
		container.innerHTML = '';
		if (!stations.length) {
			status.textContent = 'No station data.';
			return;
		}
		status.textContent = `Top ${stations.length} stations.`;

		const width = container.clientWidth - margin.left - margin.right;
		const height = chartHeight - margin.top - margin.bottom;

		const svg = d3
			.select(container)
			.append('svg')
			.attr('width', width + margin.left + margin.right)
			.attr('height', height + margin.top + margin.bottom)
			.append('g')
			.attr('transform', `translate(${margin.left},${margin.top})`);

		const x = d3.scaleBand()
			.domain(stations.map((d) => d.station_name))
			.range([0, width])
			.padding(0.1);
		const y = d3
			.scaleLinear()
			.domain([0, d3.max(stations, (d) => d.trip_count) ?? 1])
			.nice()
			.range([height, 0]);

		svg.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(x))
			.selectAll('text')
			.attr('transform', 'rotate(-45)')
			.style('text-anchor', 'end');
		svg.append('g').call(d3.axisLeft(y));

		svg
			.selectAll('rect')
			.data(stations)
			.join('rect')
			.attr('x', (d) => x(d.station_name) ?? 0)
			.attr('y', (d) => y(d.trip_count))
			.attr('width', x.bandwidth())
			.attr('height', (d) => height - y(d.trip_count))
			.attr('fill', '#1565c0')
			.attr('opacity', 0.8);
	}

	function renderNullCounts(nulls: Record<string, number>) {
		const container = getContainer('chart-nulls');
		const status = getContainer('status-nulls');
		container.innerHTML = '';
		const entries = Object.entries(nulls).filter(([, v]) => v > 0);
		if (!entries.length) {
			status.textContent = 'No missing values.';
			return;
		}
		status.textContent = `${entries.length} columns with nulls.`;

		const width = container.clientWidth - margin.left - margin.right;
		const height = 180 - margin.top - margin.bottom;

		const svg = d3
			.select(container)
			.append('svg')
			.attr('width', width + margin.left + margin.right)
			.attr('height', height + margin.top + margin.bottom)
			.append('g')
			.attr('transform', `translate(${margin.left},${margin.top})`);

		const x = d3.scaleBand()
			.domain(entries.map(([k]) => k))
			.range([0, width])
			.padding(0.1);
		const y = d3
			.scaleLinear()
			.domain([0, d3.max(entries, ([, v]) => v) ?? 1])
			.nice()
			.range([height, 0]);

		svg.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(x))
			.selectAll('text')
			.attr('transform', 'rotate(-45)')
			.style('text-anchor', 'end');
		svg.append('g').call(d3.axisLeft(y));

		svg
			.selectAll('rect')
			.data(entries)
			.join('rect')
			.attr('x', (d) => x(d[0]) ?? 0)
			.attr('y', (d) => y(d[1]))
			.attr('width', x.bandwidth())
			.attr('height', (d) => height - y(d[1]))
			.attr('fill', '#c62828')
			.attr('opacity', 0.8);
	}

	function renderOutlierFigure() {
		const container = getContainer('outlier-figure');
		container.innerHTML = '';
		const img = document.createElement('img');
		img.src = `${base}prepared-data/figures/eda_outlier_duration.png`;
		img.alt = 'Outlier detection (duration)';
		img.className = 'max-w-full h-auto rounded';
		img.onerror = () => {
			container.innerHTML = '<p class="text-sm text-amber-600 dark:text-amber-400">Figure not found. Run the pipeline to generate eda_outlier_duration.png.</p>';
		};
		container.appendChild(img);
	}

	render();
</script>
